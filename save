

# OpenAI Client initialisieren
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
app = FastAPI()
app.mount("/generated", StaticFiles(directory=os.path.join(os.getcwd(),
          "generated")), name="generated")

# --- CORS (Frontend darf Backend ansprechen) ---
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # spÃ¤ter kÃ¶nnen wir das genauer einstellen
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- Testroute ---


@app.get("/")
def read_root():
    return {"message": "Backend is running ðŸš€"}


class PreviewRequest(BaseModel):
    prompt: str
    num_lessons: int
    videos_per_lesson: int
    include_quiz: bool
    include_workbook: bool
    format: Optional[str] = None
    outcome: str | None = None
    audience: str | None = None
    audienceLevel: str | None = None
    materials: str | None = None
    links: str | None = None  # ðŸ‘ˆ Neu


@app.post("/api/preview-course")
async def preview_course(req: PreviewRequest):
    """
    Generate a simple course preview (structure only, no full content).
    Deterministic lesson count chosen from format ranges (no randomness).
    """
    # Log input for easier debugging
    print("ðŸ§© preview_course called with:", req.model_dump())

    # Logical lesson ranges by format
    format_ranges = {
        "Micro": (3, 5),
        "Standard": (6, 10),
        "Masterclass": (12, 15)
    }

    # Default: use provided num_lessons if present
    min_lessons, max_lessons = (req.num_lessons, req.num_lessons)

    # If format provided, override ranges
    if getattr(req, "format", None):
        fmt = req.format.capitalize()
        if fmt in format_ranges:
            min_lessons, max_lessons = format_ranges[fmt]

    # Deterministic choice: use the integer midpoint of the range
    exact_count = (min_lessons + max_lessons) // 2

    prompt = f"""
You are an expert instructional designer.

The user provided this base information:

- Goal / Outcome: {req.outcome or "No outcome provided"}
- Target Audience: {req.audience or "Not specified"} ({req.audienceLevel or "-"})
- Course Size: {req.format or "Standard"}
- Materials or resources: {req.materials or "None"}
- Reference links or files: {req.links or "None"}

Topic prompt from user:
{req.prompt}

Now create a course structure in valid JSON for this topic.

Format: {req.format or "Standard"} Course

Guidelines (deterministic):
- Generate exactly {exact_count} lessons (not a range).
- Each lesson should have about {req.videos_per_lesson} videos.

Each lesson must include:
- "lesson_title"
- "video_titles" (list of strings)
- "quiz": true/false
- "workbook": true/false

Always keep "quiz"={req.include_quiz} and "workbook"={req.include_workbook}.

Return ONLY valid JSON. Do NOT wrap output in markdown code fences or add explanatory text.
"""

    # Use low temperature for deterministic output
    completion = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.0,
    )

    raw = completion.choices[0].message.content
    print("ðŸ§  Raw OpenAI Output:", raw[:1000])
    return {"preview": raw}


UPLOAD_DIR = Path("uploaded_files")
UPLOAD_DIR.mkdir(exist_ok=True)


"http://127.0.0.1:8000"
